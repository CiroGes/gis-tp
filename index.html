<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Pibe's Map</title>

    <!-- archivo CSS con los estilos propios de OpenLayers -->
    <link rel="stylesheet" href="ol4/css/ol.css" type="text/css">

    <!-- agregado JQuery -->
    <script src="jquery-3.3.1.js" type="text/javascript"></script>

    <!-- agregado Bootstrap -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" type="text/css">
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

    <!-- tag script que incluye el archivo .js que contiene la libreria -->
    <script src="ol4/build/ol.js" type="text/javascript"></script>

    <!-- script para realizar mediciones -->
    <script src="measure.js" type="text/javascript"></script>

    <!-- script encargado de instanciar OpenLayers -->
    <script src="app.js" type="text/javascript"></script>

    <!-- estilos CSS de la aplicación -->
    <link rel="stylesheet" href="style.css" type="text/css">

    <!-- más íconos de fontawesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-default" id="nav_bar">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">
                    <span class="fas fa-map"></span>
                    <span class="blue logo">P</span>
                    <span class="red logo">i</span>
                    <span class="yellow logo">b</span>
                    <span class="blue logo">e</span>
                    <span  class="green logo">'s</span>
                    Map
                </a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <!-- <li><a href="#">Link <span class="sr-only">(current)</span></a></li>
                    <li><a href="#">Link</a></li> -->
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Main Layers <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" id="red_vial" class="main-layers">
                                <span class="blue logo">Red Vial</span>
                            </a></li>
                            <li><a href="#" id="espejo_de_agua_hid" class="main-layers">
                                <span class="red logo">Espejos de Agua</span>
                            </a></li>
                            <li><a href="#" id="veg_cultivos" class="main-layers">
                                <span class="red logo">Vegetación Cultivos</span>
                            </a></li>
                            <li><a href="#" id="veg_arborea" class="main-layers">
                                <span class="red logo">Vegetación Arbórea</span>
                            </a></li>
                            <li><a href="#" id="veg_hidrofila" class="main-layers">
                                <span class="red logo">Vegetación Hidrófila</span>
                            </a></li>
                        </ul>
                    </li>
                    <li class="active">
                        <a href="#" id="nav-ctrl" class="select-ctrl" title="Navegación">
                            <span class="fas fa-lg fa-hand-paper"></span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="box-ctrl" class="select-ctrl" title="Consulta">
                            <span class="fas fa-lg fa-vector-square"></span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="measure-length-ctrl" class="select-ctrl" title="Medir distancia">
                            <span class="fas fa-lg fa-ruler-horizontal"></span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="measure-area-ctrl" class="select-ctrl" title="Medir área">
                            <span class="fas fa-lg fa-ruler-combined"></span>
                        </a>
                    </li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>

    <!-- Barra lateral con lista de capas -->
    <div class="col-sm-3 col-md-2 sidebar" style="z-index: 100; margin-top: 100px; padding-left: 30px;">
        <div class="mini-submenu" style="background-color: #fff; border: 1px solid #ddd;">
            <span class="fas fa-lg fa-layer-group" style="margin-left: 2px; margin-top: 4px; color: #555;"></span>
        </div>
        <div class="list-group" style="display: none;">
            <span href="#" class="list-group-item active text-center">
                <b>Listado de Capas</b>
                <span class="pull-right" id="slide-submenu">
                    <i class="fa fa-times"></i>
                </span>
            </span>
            <div id="layers-list" style="height: 500px; overflow-y: scroll;">
                <!-- Acá se carga el listado de capas -->
            </div>
        </div>
    </div>


    <div id="map">
        <!-- DIV que contiene el mapa -->
    </div>


    <script type="text/javascript">
        $(document).ready(function() {
            $('#slide-submenu').on('click',function() {
                $(this).closest('.list-group').fadeOut('slide',function(){
                    $('.mini-submenu').fadeIn();
                });
            });

            $('.mini-submenu').on('click',function(){
                $(this).next('.list-group').toggle('slide');
                $('.mini-submenu').hide();
            })

            $('.main-layers').click(function() {
                // Habilito/Deshabilito una capa
                toggleLayerVisibility($(this).attr('id'));

                // Cambio estéticamente el botón
                $(this).find('span').toggleClass('red blue');
            });

            $('.select-ctrl').click(function() {
                $('ul.nav.navbar-nav').find('li.active').removeClass('active');
                $(this).parent().addClass('active');

                seleccionarControl($(this).attr('id'));
            });

            $('.layer-item').click(function() {
                let layer_name = $(this).attr('id');
                toggleLayerVisibility(layer_name);
            });

            select_interaction.on('boxend', function() {
                let coordinates = this.getGeometry().getCoordinates();
                let wkt_coordinates = wktFormat(coordinates);
                console.log('boxend', coordinates);
                console.log(wkt_coordinates);

                let layer_name = findLayerBy('visible', true).getProperties().name;

                // Template string example
                // `Hello ${name}, how are you ${time}?`
                let url_features = url + `&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&QUERY_LAYERS=${layer_name}&INFO_FORMAT=text/xml&CRS=EPSG%3A4326&FEATURE_COUNT=10&FILTER_GEOM=${wkt_coordinates}`;

                fetch(url_features)
                .then(response => response.text())
                .then(data => {
                    console.log('URL: ' + url_features);
                    console.log(data);
                    console.log('---------------------------------------------');

                    let parser = new DOMParser();
                    let xml_doc = parser.parseFromString(data, "text/xml");
                    console.log(xml_doc);

                    // let win = window.open(url, '_blank');
                    // win.focus();
                });
            });
        }); // Fin $(document).ready()


        // Funcion que habilita/deshabilita una capa con el nombre dado
        var toggleLayerVisibility = function(layer_name) {
            let layer = findLayerBy('name', layer_name);

            layer.setVisible(!layer.getVisible());
            return layer.getVisible();
        };


        // Funcion que formatea un poligono a WKT
        var wktFormat = function(coordinates) {
            let wkt = 'POLYGON((';

    		for (let i = 0; i < coordinates[0].length - 1; i++) {
    			wkt += coordinates[0][i][0] + ' ' + coordinates[0][i][1] + ',';
    		}

    		wkt += coordinates[0][0][0] + ' ' + coordinates[0][0][1]+'))';

            return wkt;
        };


        // Funcion que habilita/deshabilita controles
        var seleccionarControl = function(element) {
            if (element === 'box-ctrl') {    // Consulta por Polígono
                map.removeInteraction(draw);
                map.addInteraction(select_interaction);
            } else if (element === 'nav-ctrl') {    // Navegación
                map.removeInteraction(draw);
                map.removeInteraction(select_interaction);
            } else if (element === 'measure-length-ctrl' || element === 'measure-area-ctrl') {    // Medición de distancias y áreas
                map.removeInteraction(draw);
                map.removeInteraction(select_interaction);
                addInteraction();
            }

            console.log(element);
        };


        // Función que habilita/deshabilita legenda de una capa
        var toggleLegend = function(layer_name) {
            let url_legend = url + `&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${layer_name}`;

            fetch(url_legend);
        }


        // Definición de una interacción
        var select_interaction = new ol.interaction.DragBox({
            condition: ol.events.condition.always, //noModifierKeys
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: [0, 0, 255, 1]
                })
            })
        });
    </script>
</body>
</html>
